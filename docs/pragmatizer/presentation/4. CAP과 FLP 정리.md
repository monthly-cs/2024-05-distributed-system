# 4. CAP과 FLP 정리

## 4.1. 복제 시 발생하는 네트워크 장애

- 램포트 시계를 통한 논리적 시각개념으로 전체 순서와 원자성 충족할 수 있으나 네트워크 장애가 발생 할 수 있음

### 비일관성의 문제

- 네트워크 지연/장애 발생 시 가용성을 극대화하면 비일관성이 발생할 수 있음

### 가용성의 문제

- 비일관성 문제를 해결하기 위해 프로토콜에 따라 처리하면 서비스 지연이 발생할 수 있음

### 궁극적 또는 강한 일관성

- 순간적으로 어느 시점에서는 비일관성이 발생하지만, 궁극적으로는 내용이 일관되는 것을 궁극적 일관성이라고 함
    - 지역적으로 분리된 경우 캐시 서버의 예시. 지역적 서버 간 복제가 필요함
    - 복제 과정에서 지연으로 비일관성의 문제가 생기는 경우 강한 일관성을 지켜야 할까?

### 일관성과 가용성 동시 충족 딜레마

- 단절 내성(Partition-tolerant)
    - 네트워크가 단절되더라도 두 프로세스가 자율적으로 각자의 작업을 수행하는 것
- CAP(Consistency, Availability, Partition-tolernat) 정리
    - 단절 내성 상태에서는 강한 일관성과 가용성을 동시에 충족하는 것이 불가능하다고 증명됨
- CAP 정리에 따라 애플리케이션 특성에 맞는 정책 필요
    - 은행 : 강한 일관성 (가용성 포기)
    - 소셜 미디어 : 가용성 충족 (궁극적 일관성)

## 4.2. 합의

- 두 장치의 경우 2단계 커밋 프로토콜

### 합의 조건

- 3개 이상의 분산 장치가 상호 합의해야 하는 경우 해결책
- 합의 충족 여부 판단 기준
    - 종결(Termination) : 장애가 없는 모든 분산된 장치들은 궁극적으로 어떤 값을 결정함
    - 동의(Agreement) : 장치들이 어떤 값을 결정했다면 그 값들은 모두 동일해야 함
    - 타당성(Validity) : 결정된 어떤 값은 반드시 누군가로부터 제안된 것임

## 4.3. FLP 정리

### 분산 장치들 간의 동일값 결정 문제

- FLP : Michael Fischer, Nancy Lynch, Michael Paterson
    - 각 분산 장치가 무기한 메시지 지연이 발생할 수 있는 비동기적 네트워크 상에서 반드시 어떤 값을 결정해야 하며, 궁극적으로 장애를 겪지 않은 장치들은 합의에 도달해야 함
    - 회식 예시
        - 참석이 불가한지 메시지가 도달하지 않은 건지?
    - 결정론적 합의 알고리즘
        - 특정한 입력값에 대해서 항상 동일한 과정으로 같은 결과를 내는 것을 의미
            - 비결정론적인 경우 결과를 예측 할 수 없다는 의미로 모든 분산된 프로세스가 동일한 값을 동의할 지 확신할 수 없다는 의미
        - 결정론적 합의 알고리즘은 존재하지 않음
            - 분산 장치들의 초기 설정 상태에서 일련의 메시지 교환 과정 중 장애를 겪는 장치가 하나라도 있다면 각 분산 장치들의 상태가 변화하면서 어떤 동일한 결정을 내닐지 알 수 없거나 누군가는 결정을 내리지 못하는 상태가 발생할 수 있음

### 장애 발생 시 결정론적 합의 알고리즘 존재 여부

- 알고리즘을 비결정론적으로 만드는 주요 원인 중 하나는 장애임
    - 장애가 없다면 메시지를 제때 주고 받을 수 있음
- FLP정리는 하나의 장애를 일으키는 분산 장치가 있는 경우 장애가 없는 나머지 프로세스들의 합의, 동의, 타당성을 확신할 수 없음을 증명

## 4.4. 무결한 프로세스 간의 합의

- FLP정리는 합의 시작 시점부터 장애로 작동하지 않는 프로세스가 있다면 해당 프로세스를 배제하고 정상적으로 메시지를 주고 받을 수 있는 무결한 프로세스들 간에 합의가 이루어질 수 있게 하는 방안을 고안함

### 정족수 충족 합의

- 합의 과정에서 어떤 프로세스가 장애가 있는 지 알 수 없기 때문에 상호 메시지를 주고 받으면서 무결한 프로세스를 파악해야 함
- 과반수의 프로세스가 무결하다는 합의를 달성하기 위해서는 정족수를 만족해야 함
- 장애 프로세스까지 모두 억지로 합의에 이르게 하는 것이 아니라 배제시켜 정해진 정족수 제약 조건하에 무결한 프로세스들 간의 종결, 동의, 타당성 조건을 만족시켜야 함
    - 다자간의 완전한 합의는 하나의 프로세스라도 문제를 일으키면 안됨
    - 장애 가능성이 있다는 것을 감안하여 무결한 프로세스간이라도 합의해야 함

### 직장인 회식 여부 합의 예시

- A, B, C 간 서로 메시지를 주고 받으며 응답하지 않는 C를 배제함
- A, B는
    - 무결한 프로세스로서 결정을 내렸으므로 종결 조건 충족
    - 동일한 결정을 내렸으므로 동의 조건 충족
    - A가 제안했으므로 타당성 조건 충족

### 핵심 요약

- CAP 정리는 네트워크 단절로부터 회복이 이루어지는 ‘단절 내성(Partition-tolerant)’ 상태에서 복제 정보를 다루는 분산 프로세스들 간의 일관성과 가용성을 동시에 충족하지 못함을 증명한 이론임
- 분산 컴퓨팅의 용도에 따라, 단절 내성 상태에서 일관성을 우선시 할지, 가용성을 우선시 할지 정책적인 결정을 내려야 함
- 분산된 프로세스들 간의 복제 정보들이 결국 일관성을 가지게 되는 것을 ‘궁극적 일관성(Eventual Consistency)’라고 함. 정보의 상시적 노출이 더 중요한 소셜 미디어 등에서 가용성을 우선시하여 궁극적 일관성이 이루어지게 할 수 있음
- 분산 프로세스들 간의 합의가 제대로 이루어졌는지 판단하기 위해서 ‘종결(Termination)’, ‘동의(Agreement)’, ‘타당성(Validity)’ 등 세가지 조건이 충족되었는 지 확인해야 함
- FLP 정리에 의하면 단 하나의 분산 프로세스가 장애를 일으키더라도 합의에 이를 수 있는 지를 결정론적으로 알 수 없음
- 장애를 일으키는 프로세스를 메시지를 서로 주고받는 과정에서 확인하고 장애 프로세스를 배제하며 ‘정족수(Quorum)’의 무결한 프로세스들이 합의에 이를 수 있다는 것을 FLP 정리 저자들에 의해서 제시되었음
