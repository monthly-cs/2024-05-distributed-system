# DIL

> 24.05.01 - 24.06.30  
> `핵심 이론부터 프로그래밍 실습까지, 분산 컴퓨팅`  
> 
> 1. 읽은 내용은 간단히 정리합니다.
> 2. 생각을 더 자세히 작성합니다.
> 3. 추가로 공부한 내용을 더 자세히 작성합니다.

---

## 2장 중계자와 2단계 커밋 프로토콜

### 2.3 2단계 커밋 프로토콜
**[ 트랜잭션 코디네이터(TC) ]**
트랜잭션 참여자들 간의 통신을 조정하는 중앙의 중개자
> 중개 VS 중계
> 둘 다 중간에서 이어준다는 개념이지만 중개는 제 3자의 입장이다. 
> 중계 무역: A 회사 제품 수입해서 B 회사로 파는 무역
> 중개 무역: A 회사와 B 회사를 소개해주고 수수료를 받는 무역

**[ 스트로우맨 프로토콜 ]**
강력한 권한을 가진 중앙의 중개자
- 트랜잭션 참여자 또는 네트워크에서 장애가 발생하면 안전하지 않다.
- 장애를 인지하기도 어렵다. 왜? TBU
  
**[ 원자적 커밋 프로토콜 ]**
> 원자적(Atomic): 참여자들의 역할 수행은 모두 완전히 실행되거나 실행되지 않아야 한다.
> 커밋(Commit): 확약. 특정 목표를 달성하기 위한 약속을 이행함.
1. 준비 명령 (Prepare): TC는 참여자들에게 준비 상태를 물어봄. Yes / No 로 회신
2. 커밋 명령 (Commit): 모든 참여자가 준비 상태면 TC가 모든 참여자들에게 커밋 명령을 내림.
3. 취소 명령 (Abort): 하나라도 준비 상태가 아니면 TC가 모든 참여자들에게 취소 명령을 내림.

**안정성 보장을 위한 조치**
- 응답과 회신에 대한 기록을 남겨, 장애 복구 이후 상황을 파악함.
- 참여자가 준비 명령에 대한 회신 기록이 없다면 준비 명령을 취소함.
- TC는 참여자에게 커밋 메시지를 보낸 기록이 없으면 명령을 취소함.

**라이브니스 보장을 위한 조치**
> 본인이 선제적으로 기록을 남기는데 성공했어도  
> 프로세스의 회신을 기다리거나 TC의 요청을 하염없이 기다리는 문제는 라이브니스를 떨어트린다.
> 혹은, 다시 처음부터 과정을 트랜잭션을 시도하는 것은 번거롭고 시간 낭비이다.
- TC는 참여자의 응답을 기다리다 특정 시간이 지나면 트랜잭션 취소 명령을 내릴 수 있다.
- 다른 참여자에게 TC 와의 의사소통 여부를 질의하는 방법으로 라이브니스를 충족할 수 있다.

**[ 2단계 커밋 프로토콜 ]**
> 원자적 커밋 프로토콜  
> +선제적 메시지 기록  
> +메시지 재전송  
> +프로토콜 종료 및 재시작  
> => **Two-Phase Commit Protocol (2PC)**

**알고리즘 정리**
1. 클라이언트가 TC에게 트랜잭션 명령 메시지 송신
2. TC는 참여자들에게 트랜잭션 준비 명령 송신
3. 각 참여자는 TC에 Yes / No 회신
4. TC의 결정

**예외 케이스**
1. 프로세스가 준비 명령에 대한 기록을 남기기 전에 장애
- TC는 응답시간 안에 프로세스의 회신이 없었으므로 취소 명령
- 복구된 프로세스는 준비 기록이 없으므로 준비 명령을 취소
2. 프로세스가 커밋 명령 받기 전에 장애
- 복구된 프로세스는 준비 완료 기록이 있지만 확약 수행 명령을 받은 적이 없으므로 준비 완료 메시지를 다시 회신
- TC는 이미 취소 명령을 내렸으므로 취소 명령을 다시 내림
3. TC의 장애로 프로세스에게 커밋 명령을 못 내리는 경우
- 프로세스는 다른 프로세스에게 커밋 명령을 받았는지 문의하여 수행 여부 결정